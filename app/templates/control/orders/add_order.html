{% extends "control/base.html" %}

{% block title %}Добавление заказа{% endblock title %}

{% block content %}
<div class="content-section">
    <div class="tabs">
        <form method="GET" action="{{ url_for('control.orders.orders_table') }}">
            <button class="tab-button"><i class="fas fa-list"></i>Список заказов</button>
        </form>
        <form method="GET" action="{{ url_for('control.orders.add_order') }}">
            <button class="tab-button active"><i class="fas fa-plus"></i>Добавить заказ</button>
        </form>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>Номер заказа</label>
            <div>
                <i class="fas fa-hashtag"></i>
                <input type="text"
                       name="order_number"
                       value="{{ request.form.get('order_number', '') }}"
                       class="order-number"
                       placeholder="Номер заказа"
                       autocomplete="off"
                       required/>
            </div>
        </div>

        <div class="form-group">
            <label>Наименование заказа</label>
            <div>
                <i class="fas fa-cogs"></i>
                <input type="text"
                       name="order_name"
                       value="{{ request.form.get('order_name', '') }}"
                       class="order-name"
                       placeholder="Наименование заказа"
                       autocomplete="off"
                       required/>
            </div>
        </div>

        <!-- Вкладки для загрузки файла и ручного ввода -->
        <div class="sub-tabs">
            <button type="button" class="sub-tab-button active" data-tab="file-tab">
                <i class="fas fa-file-upload"></i> Загрузка файла
            </button>
            <button type="button" class="sub-tab-button" data-tab="manual-tab">
                <i class="fas fa-edit"></i> Ручной ввод
            </button>
        </div>

        <div class="tab-content active" id="file-tab">
            <div class="form-group">
                <label>Перечень работ для заказа (файл)</label>
                <p class="upload-instruction">
                    Формат: первая колонка — наименование работы, вторая — плановая трудоемкость.
                    Допустимые расширения: XLSX, XLS
                </p>

                <div class="file-upload-container">
                    <input type="file"
                           name="file_upload"
                           class="file-upload"
                           accept=".xlsx,.xls"/>
                    <button type="button" class="upload-button">Выбрать таблицу</button>
                    <span class="file-upload-label">Таблица не выбрана</span>
                </div>
            </div>
        </div>

        <div class="tab-content" id="manual-tab">
            <div class="form-group">
                <label>Перечень работ для заказа (ручной ввод)</label>
                <p class="upload-instruction">
                    Введите наименование работы и плановую трудоемкость. Можно добавить несколько строк.
                </p>
                <table class="manual-table">
                    <thead>
                        <tr>
                            <th>Наименование работы</th>
                            <th>Плановые часы</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="manual-rows">
                        <tr>
                            <td><input type="text" name="work_name[]" required></td>
                            <td><input type="number" name="work_hours[]" step="0.1" required></td>
                            <td><button type="button" class="remove-row">&times;</button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" id="add-row" class="default-button">
                    <i class="fas fa-plus"></i> Добавить работу
                </button>
            </div>
        </div>

        <div class="form-buttons">
            <button type="submit" class="default-button">
                <i class="fas fa-save"></i> Сохранить заказ
            </button>

            <a href="{{ url_for('control.orders.orders_table') }}" class="default-button">
                <i class="fas fa-undo"></i>Отменить
            </a>
        </div>
    </form>

    <div class="flashed-messages">
        {% for category, message in get_flashed_messages(with_categories=true) %}
            <div class="{{ category }}" id="message">
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Скрипт для переключения табов и добавления/удаления строк -->
<script>
document.querySelectorAll('.sub-tab-button').forEach(button => {
    button.addEventListener('click', () => {
        document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
    });
});

// Добавление новой строки
document.getElementById('add-row').addEventListener('click', () => {
    const tbody = document.getElementById('manual-rows');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" name="work_name[]" required></td>
        <td><input type="number" name="work_hours[]" step="0.1" required></td>
        <td><button type="button" class="remove-row">&times;</button></td>
    `;
    tbody.appendChild(newRow);
});

// Удаление строки
document.getElementById('manual-rows').addEventListener('click', e => {
    if (e.target.classList.contains('remove-row')) {
        e.target.closest('tr').remove();
    }
});
</script>

<style>
/* Стили для подтабов */
.sub-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.sub-tab-button {
    padding: 8px 16px;
    border: 1px solid #ccc;
    background: #f0f0f0;
    cursor: pointer;
}
.sub-tab-button.active {
    background: #fff;
    border-bottom: 2px solid #007bff;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.manual-table {
    border-collapse: collapse;
    margin-top: 10px;
    width: 600px;
}
.manual-table th, .manual-table td {
    border: 1px solid #ccc;
    padding: 5px;
    text-align: left;
}
.remove-row {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: red;
}
</style>
{% endblock content %}
